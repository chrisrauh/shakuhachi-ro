var ShakuhachiScore=function(b){"use strict";var it=Object.defineProperty;var st=(b,v,y)=>v in b?it(b,v,{enumerable:!0,configurable:!0,writable:!0,value:y}):b[v]=y;var c=(b,v,y)=>st(b,typeof v!="symbol"?v+"":v,y);const v={C4:{step:"ro",octave:0,dai_meri:!0},"C#4":{step:"ro",octave:0,meri:!0},Db4:{step:"ro",octave:0,meri:!0},D4:{step:"ro",octave:0},"D#4":{step:"tsu",octave:0,meri:!0},Eb4:{step:"tsu",octave:0,meri:!0},E4:{step:"tsu",octave:0,chu_meri:!0},F4:{step:"tsu",octave:0},"F#4":{step:"re",octave:0,meri:!0},Gb4:{step:"re",octave:0,meri:!0},G4:{step:"re",octave:0},"G#4":{step:"u",octave:0},Ab4:{step:"u",octave:0},A4:{step:"chi",octave:0},"A#4":{step:"chi",octave:0,meri:!0},Bb4:{step:"chi",octave:0,meri:!0},B4:{step:"ri",octave:0,chu_meri:!0},C5:{step:"ri",octave:0},"C#5":{step:"ro",octave:1,meri:!0},Db5:{step:"ro",octave:1,meri:!0},D5:{step:"ro",octave:1},"D#5":{step:"tsu",octave:1,meri:!0},Eb5:{step:"tsu",octave:1,meri:!0},E5:{step:"tsu",octave:1,chu_meri:!0},F5:{step:"tsu",octave:1},"F#5":{step:"re",octave:1,meri:!0},Gb5:{step:"re",octave:1,meri:!0},G5:{step:"re",octave:1},"G#5":{step:"chi",octave:1,meri:!0},Ab5:{step:"chi",octave:1,meri:!0},A5:{step:"chi",octave:1},"A#5":{step:"chi",octave:1,chu_meri:!0},Bb5:{step:"chi",octave:1,chu_meri:!0},B5:{step:"ri",octave:1},C6:{step:"hi",octave:1},"C#6":{step:"ro",octave:2,meri:!0},Db6:{step:"ro",octave:2,meri:!0},D6:{step:"ro",octave:2},"D#6":{step:"tsu",octave:2,meri:!0},Eb6:{step:"tsu",octave:2,meri:!0},E6:{step:"tsu",octave:2,chu_meri:!0},F6:{step:"tsu",octave:2},"F#6":{step:"re",octave:2,meri:!0},Gb6:{step:"re",octave:2,meri:!0},G6:{step:"re",octave:2},"G#6":{step:"chi",octave:2,meri:!0},Ab6:{step:"chi",octave:2,meri:!0},A6:{step:"chi",octave:2},"A#6":{step:"hi",octave:2,meri:!0},Bb6:{step:"hi",octave:2,meri:!0},B6:{step:"hi",octave:2}};class y{static parse(e){const i=new DOMParser().parseFromString(e,"text/xml"),r=i.querySelector("work-title"),s=(r==null?void 0:r.textContent)||"Untitled",o=i.querySelector('creator[type="composer"]'),n=(o==null?void 0:o.textContent)||void 0,a=[];return i.querySelectorAll("note").forEach(u=>{var Y,H,B,G;if(u.querySelector("rest")){const tt=((Y=u.querySelector("duration"))==null?void 0:Y.textContent)||"1",et=parseInt(tt,10);a.push({rest:!0,duration:et});return}const g=u.querySelector("pitch");if(!g)return;const d=((H=g.querySelector("step"))==null?void 0:H.textContent)||"",p=((B=g.querySelector("octave"))==null?void 0:B.textContent)||"4",m=`${d}${p}`,S=v[m];if(!S){console.warn(`Unknown pitch: ${m}, skipping`);return}const Z=((G=u.querySelector("duration"))==null?void 0:G.textContent)||"1",X=parseInt(Z,10),Q=u.querySelector("dot")!==null;let D=1;X>=4?D=4:X>=2?D=2:D=1;const M={pitch:{step:S.step,octave:S.octave},duration:D};S.meri&&(M.meri=!0),S.chu_meri&&(M.chu_meri=!0),S.dai_meri&&(M.dai_meri=!0),Q&&(M.dotted=!0),a.push(M)}),{title:s,style:"kinko",notes:a,composer:n}}static async parseFromURL(e){const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load MusicXML file: ${t.statusText}`);const i=await t.text();return this.parse(i)}static toJSON(e,t=!0){return JSON.stringify(e,null,t?2:0)}static convertToJSON(e){const t=this.parse(e);return this.toJSON(t)}}const J={ro:{kana:"ロ",romaji:"ro",pitch:"D4",defaultOctave:"otsu",fingering:[!0,!0,!0,!0,!0],canAlter:!0,unicode:"U+30ED"},tsu:{kana:"ツ",romaji:"tsu",pitch:"F4",defaultOctave:"otsu",fingering:[!0,!0,!0,!0,!1],canAlter:!0,unicode:"U+30C4"},re:{kana:"レ",romaji:"re",pitch:"G4",defaultOctave:"otsu",fingering:[!0,!0,!0,!1,!1],canAlter:!0,unicode:"U+30EC"},chi:{kana:"チ",romaji:"chi",pitch:"A4",defaultOctave:"otsu",fingering:[!0,!0,!1,!1,!1],canAlter:!0,unicode:"U+30C1"},ri:{kana:"リ",romaji:"ri",pitch:"C5",defaultOctave:"otsu",fingering:[!0,!1,!1,!1,!1],canAlter:!0,unicode:"U+30EA"},u:{kana:"ウ",romaji:"u",pitch:"C4",defaultOctave:"otsu",fingering:[!0,!0,!0,!0,!0],canAlter:!1,unicode:"U+30A6"},hi:{kana:"ヒ",romaji:"hi",pitch:"E4",defaultOctave:"otsu",fingering:[!0,!0,!0,!1,!0],canAlter:!0,unicode:"U+30D2"}};function z(f){return J[f.toLowerCase()]}function U(f){const e={C:0,D:2,E:4,F:5,G:7,A:9,B:11},t=f.match(/^([A-G])(#|b)?(\d+)$/);if(!t)throw new Error(`Invalid pitch notation: ${f}`);const[,i,r,s]=t,o=e[i],n=r==="#"?1:r==="b"?-1:0;return(parseInt(s,10)+1)*12+o+n}function L(f,e){const t=z(f);if(!t)throw new Error(`Unknown note: ${f}`);return U(t.pitch)+e*12}class W{constructor(e){c(this,"kana");c(this,"symbolInfo");c(this,"x",0);c(this,"y",0);c(this,"duration");c(this,"fontSize");c(this,"fontWeight");c(this,"fontFamily");c(this,"color");c(this,"modifiers",[]);c(this,"bbox",null);c(this,"isRest");var t;this.symbolInfo=z(e.symbol),this.kana=((t=this.symbolInfo)==null?void 0:t.kana)||e.symbol,this.x=e.x??0,this.y=e.y??0,this.duration=e.duration??"q",this.fontSize=e.fontSize??32,this.fontWeight=e.fontWeight??400,this.fontFamily=e.fontFamily??"Noto Sans JP, sans-serif",this.color=e.color??"#000",this.isRest=e.isRest??!1,e.modifiers&&(this.modifiers=[...e.modifiers])}render(e){if(this.isRest){const t=this.fontSize/8,i=Math.max(1.5,t/1.9),r=this.y-this.fontSize*.4;e.drawCircle(this.x,r,t,void 0,this.color,i)}else e.drawText(this.kana,this.x,this.y,this.fontSize,this.fontFamily,this.color,"middle",this.fontWeight);this.modifiers.forEach(t=>{t.render(e,this.x,this.y)}),this.bbox=null}addModifier(e){return this.modifiers.push(e),this.bbox=null,this}addModifiers(e){return this.modifiers.push(...e),this.bbox=null,this}getModifiers(){return[...this.modifiers]}setModifiers(e){this.modifiers=e}setPosition(e,t){return this.x=e,this.y=t,this.bbox=null,this}getPosition(){return{x:this.x,y:this.y}}getKana(){return this.kana}getSymbolInfo(){return this.symbolInfo}getDuration(){return this.duration}setDuration(e){return this.duration=e,this}getBBox(){if(this.bbox)return this.bbox;const e=this.fontSize*.8,t=this.fontSize;let i=this.x-e/2,r=this.y-t,s=this.x+e/2,o=this.y;return this.modifiers.forEach(n=>{const a=n.getOffset(),h=n.getWidth(),u=n.getHeight(),l=this.x+a.x,g=this.y+a.y;i=Math.min(i,l-h/2),r=Math.min(r,g-u/2),s=Math.max(s,l+h/2),o=Math.max(o,g+u/2)}),this.bbox={x:i,y:r,width:s-i,height:o-r},this.bbox}getWidth(){return this.getBBox().width}getHeight(){return this.getBBox().height}setFontSize(e){return this.fontSize=e,this.bbox=null,this}setFontWeight(e){return this.fontWeight=e,this.bbox=null,this}setColor(e){return this.color=e,this}}class k{constructor(e="above"){c(this,"offsetX",0);c(this,"offsetY",0);c(this,"position");this.position=e}setOffset(e,t){return this.offsetX=e,this.offsetY=t,this}getPosition(){return this.position}setPosition(e){return this.position=e,this}getOffset(){return{x:this.offsetX,y:this.offsetY}}getWidth(){return 0}getHeight(){return 0}}const F=class F extends k{constructor(t="kan"){super("above");c(this,"register");c(this,"fontSize",12);c(this,"fontWeight",400);c(this,"fontFamily","Noto Sans JP, sans-serif");c(this,"color","#000");this.register=t,this.setDefaultOffsets()}setDefaultOffsets(){this.offsetX=18,this.offsetY=-22}render(t,i,r){const s=i+this.offsetX,o=r+this.offsetY,n=F.registerSymbols[this.register];t.drawText(n,s,o,this.fontSize,this.fontFamily,this.color,"middle",this.fontWeight)}setFontSize(t){return this.fontSize=t,this}setFontWeight(t){return this.fontWeight=t,this}setFontFamily(t){return this.fontFamily=t,this}setColor(t){return this.color=t,this}getRegister(){return this.register}getWidth(){return this.fontSize*.8}getHeight(){return this.fontSize}};c(F,"registerSymbols",{otsu:"乙",kan:"甲",daikan:"大甲"});let x=F;const E=class E extends k{constructor(t="meri",i="left"){super(i);c(this,"type");c(this,"fontSize",16);c(this,"fontWeight",400);c(this,"fontFamily","Noto Sans JP, sans-serif");c(this,"color","#000");this.type=t,this.setDefaultOffsets()}setDefaultOffsets(){this.position==="left"?(this.offsetX=-22,this.offsetY=0):this.position==="right"?(this.offsetX=22,this.offsetY=0):(this.offsetX=0,this.offsetY=this.position==="above"?-30:20)}render(t,i,r){const s=i+this.offsetX,o=r+this.offsetY,n=E.symbols[this.type];t.drawText(n,s,o,this.fontSize,this.fontFamily,this.color,"middle",this.fontWeight)}setFontSize(t){return this.fontSize=t,this}setFontWeight(t){return this.fontWeight=t,this}setFontFamily(t){return this.fontFamily=t,this}setColor(t){return this.color=t,this}getType(){return this.type}getWidth(){return this.fontSize*.8}getHeight(){return this.fontSize}};c(E,"symbols",{meri:"メ","chu-meri":"中","dai-meri":"大"});let w=E;class C extends k{constructor(t="right"){super(t);c(this,"dotRadius",2.5);c(this,"color","#000");this.setDefaultOffsets()}setDefaultOffsets(){this.position==="right"?(this.offsetX=15,this.offsetY=0):(this.offsetX=0,this.offsetY=12)}render(t,i,r){const s=i+this.offsetX,o=r+this.offsetY;t.drawCircle(s,o,this.dotRadius,this.color)}setDotRadius(t){return this.dotRadius=t,this}setColor(t){return this.color=t,this}getWidth(){return this.dotRadius*2}getHeight(){return this.dotRadius*2}}const q={verticalSpacing:44};class N extends k{constructor(t,i=!1,r="right"){super(r);c(this,"lineCount");c(this,"lineLength");c(this,"lineSpacing",8);c(this,"lineWidth",1.5);c(this,"color","#000");this.lineCount=t;const s=-32*.25,o=-22;if(i)this.lineLength=s-o;else{const n=q.verticalSpacing+s;this.lineLength=n-o}this.setDefaultOffsets()}setDefaultOffsets(){this.position==="right"?(this.offsetX=26,this.offsetY=-22):(this.offsetX=0,this.offsetY=15)}render(t,i,r){const s=i+this.offsetX,o=r+this.offsetY;for(let n=0;n<this.lineCount;n++){const a=n*this.lineSpacing;t.drawLine(s+a,o,s+a,o+this.lineLength,this.color,this.lineWidth)}}setLineLength(t){return this.lineLength=t,this}setLineSpacing(t){return this.lineSpacing=t,this}setLineWidth(t){return this.lineWidth=t,this}setColor(t){return this.color=t,this}getWidth(){return this.lineCount===0?0:this.lineWidth+(this.lineCount-1)*this.lineSpacing}getHeight(){return this.lineLength}getLineCount(){return this.lineCount}}function I(f){switch(f){case 1:return"q";case 2:return"h";case 4:return"w";default:return"q"}}function O(f){return f>=2?0:f>=1?1:f>=.5?2:3}class P{static parse(e,t="#000"){this.validate(e);const i=[];let r=null;for(let s=0;s<e.notes.length;s++){const o=e.notes[s];if(o.rest){const u=new W({symbol:"rest",duration:I(o.duration),isRest:!0,color:t}),l=O(o.duration);if(l>0){const g=s===e.notes.length-1||O(e.notes[s+1].duration)===0,d=new N(l,g,"right");u.addModifier(d)}i.push(u);continue}if(!o.pitch)throw new Error(`Note at index ${s} must have pitch when rest is not set`);const n=this.needsOctaveMark(o.pitch.step,o.pitch.octave,r,s===0||r===null),a=new W({symbol:o.pitch.step,duration:I(o.duration),color:t});if(n){const u=o.pitch.octave===0?"otsu":"kan",l=new x(u);a.addModifier(l)}if(o.meri){const u=new w("meri");a.addModifier(u)}if(o.chu_meri){const u=new w("chu-meri");a.addModifier(u)}if(o.dai_meri){const u=new w("dai-meri");a.addModifier(u)}if(o.dotted){const u=new C("below");a.addModifier(u)}const h=O(o.duration);if(h>0){const u=s===e.notes.length-1||O(e.notes[s+1].duration)===0,l=new N(h,u,"right");a.addModifier(l)}i.push(a),r=L(o.pitch.step,o.pitch.octave)}return i}static needsOctaveMark(e,t,i,r){if(r||i===null)return t!==0;const s=this.findClosestOctave(e,i);return t!==s}static findClosestOctave(e,t){let i=0,r=1/0;for(let s=0;s<=2;s++){const o=L(e,s),n=Math.abs(o-t);n<r&&(r=n,i=s)}return i}static validate(e){if(!e)throw new Error("Score data is required");if(!e.title)throw new Error("Score title is required");if(!e.style)throw new Error("Score style is required");if(!Array.isArray(e.notes))throw new Error("Score notes must be an array");if(e.notes.length===0)throw new Error("Score must contain at least one note");e.notes.forEach((t,i)=>{if(t.rest){if(!t.duration)throw new Error(`Rest at index ${i} is missing duration`);return}if(!t.pitch)throw new Error(`Note at index ${i} is missing pitch`);if(!t.pitch.step)throw new Error(`Note at index ${i} is missing pitch.step`);if(t.pitch.octave===void 0||t.pitch.octave===null)throw new Error(`Note at index ${i} is missing pitch.octave`);if(t.duration===void 0||t.duration===null)throw new Error(`Note at index ${i} is missing duration`);if(t.pitch.octave<0||t.pitch.octave>2)throw new Error(`Note at index ${i} has invalid octave: ${t.pitch.octave}. Must be 0-2.`);if(t.duration<=0)throw new Error(`Note at index ${i} has invalid duration: ${t.duration}. Must be > 0.`)})}static parseJSON(e){try{const t=JSON.parse(e);return this.parse(t)}catch(t){throw t instanceof SyntaxError?new Error(`Invalid JSON: ${t.message}`):t}}static async loadFromURL(e){try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to load score: ${t.statusText}`);const i=await t.json();return this.parse(i)}catch(t){throw t instanceof Error?new Error(`Failed to load score from URL: ${t.message}`):t}}}const R="http://www.w3.org/2000/svg";class _{constructor(e,t=800,i=600){c(this,"svg");c(this,"width");c(this,"height");c(this,"groups",[]);c(this,"currentParent");this.width=t,this.height=i,this.svg=document.createElementNS(R,"svg"),this.svg.setAttribute("width",String(t)),this.svg.setAttribute("height",String(i)),this.svg.setAttribute("viewBox",`0 0 ${t} ${i}`),this.currentParent=this.svg,e.appendChild(this.svg)}round(e){return+e.toFixed(3)}create(e){return document.createElementNS(R,e)}add(e){this.currentParent.appendChild(e)}drawText(e,t,i,r=24,s="Noto Sans JP, sans-serif",o="#000",n="middle",a=400){const h=this.create("text");return h.setAttribute("x",String(this.round(t))),h.setAttribute("y",String(this.round(i))),h.setAttribute("font-size",String(r)),h.setAttribute("font-family",s),h.setAttribute("font-weight",String(a)),h.setAttribute("fill",o),h.setAttribute("text-anchor",n),h.textContent=e,this.add(h),h}drawCircle(e,t,i,r,s,o=1){const n=this.create("circle");return n.setAttribute("cx",String(this.round(e))),n.setAttribute("cy",String(this.round(t))),n.setAttribute("r",String(this.round(i))),r?n.setAttribute("fill",r):n.setAttribute("fill","none"),s&&(n.setAttribute("stroke",s),n.setAttribute("stroke-width",String(o))),this.add(n),n}drawLine(e,t,i,r,s="#000",o=1){const n=this.create("line");return n.setAttribute("x1",String(this.round(e))),n.setAttribute("y1",String(this.round(t))),n.setAttribute("x2",String(this.round(i))),n.setAttribute("y2",String(this.round(r))),n.setAttribute("stroke",s),n.setAttribute("stroke-width",String(o)),this.add(n),n}drawPath(e,t,i,r=1){const s=this.create("path");return s.setAttribute("d",e),t?s.setAttribute("fill",t):s.setAttribute("fill","none"),i&&(s.setAttribute("stroke",i),s.setAttribute("stroke-width",String(r))),this.add(s),s}openGroup(e,t){const i=this.create("g");return e&&i.setAttribute("class",e),t&&i.setAttribute("id",t),this.currentParent.appendChild(i),this.groups.push(i),this.currentParent=i,i}closeGroup(){if(this.groups.length===0){console.warn("closeGroup() called but no groups are open");return}this.groups.pop(),this.currentParent=this.groups.length>0?this.groups[this.groups.length-1]:this.svg}drawRect(e,t,i,r,s,o,n=1){const a=this.create("rect");return a.setAttribute("x",String(this.round(e))),a.setAttribute("y",String(this.round(t))),a.setAttribute("width",String(this.round(i))),a.setAttribute("height",String(this.round(r))),s?a.setAttribute("fill",s):a.setAttribute("fill","none"),o&&(a.setAttribute("stroke",o),a.setAttribute("stroke-width",String(n))),this.add(a),a}resize(e,t){this.width=e,this.height=t,this.svg.setAttribute("width",String(e)),this.svg.setAttribute("height",String(t)),this.svg.setAttribute("viewBox",`0 0 ${e} ${t}`)}clear(){for(;this.svg.firstChild;)this.svg.removeChild(this.svg.firstChild);this.groups=[],this.currentParent=this.svg}getSVG(){return this.svg}getSize(){return{width:this.width,height:this.height}}}class V{static configureModifiers(e,t){e.forEach(i=>{const r=i.getModifiers();if(t.showOctaveMarks)r.forEach(s=>{s instanceof x&&this.configureOctaveMark(s,t),s instanceof w&&this.configureMeriKariMark(s,t),s instanceof N&&s.setColor(t.noteColor),s instanceof C&&s.setColor(t.noteColor)});else{const s=r.filter(o=>!(o instanceof x));i.setModifiers(s)}})}static configureOctaveMark(e,t){e.setFontSize(t.octaveMarkFontSize).setFontWeight(t.octaveMarkFontWeight).setColor(t.noteColor)}static configureMeriKariMark(e,t){e.setFontSize(t.meriKariFontSize).setFontWeight(t.meriKariFontWeight).setColor(t.noteColor)}}class j{static calculateLayout(e,t,i,r){const s=r.columnWidth,o=r.columnSpacing,n=r.topMargin,a=r.noteVerticalSpacing,h=this.calculateColumnBreaks(e,i,n,a,r),u=h.length,l=u*s+(u-1)*o,g=(t-l)/2+s/2,d=[];for(let p=0;p<u;p++){const m=h[p].startIndex,S=h[p].endIndex;d.push(this.calculateColumnLayout(p,u,g,n,s,o,m,S,a,e,r))}return{totalColumns:u,startX:g,startY:n,columnWidth:s,columnSpacing:o,columns:d}}static calculateColumnBreaks(e,t,i,r,s){if(e.length===0)return[];const o=[];let n=0,a=i;for(let h=0;h<e.length;h++){const g=e[h].getModifiers().some(p=>p instanceof C)?s.durationDotExtraSpacing:0,d=r+g;h>n&&a+d>t?(o.push({startIndex:n,endIndex:h}),n=h,a=i+d):a+=d}return o.push({startIndex:n,endIndex:e.length}),o}static calculateColumnLayout(e,t,i,r,s,o,n,a,h,u,l){const g=i+(t-1-e)*(s+o),d=this.calculateNotePositions(n,a,r,h,u,l);return{columnIndex:e,xPosition:g,noteStartIndex:n,noteEndIndex:a,notePositions:d}}static calculateNotePositions(e,t,i,r,s,o){const n=[];let a=i;for(let h=e;h<t;h++){const u=s[h];n.push({noteIndex:h,y:a});const g=u.getModifiers().some(d=>d instanceof C)?o.durationDotExtraSpacing:0;a+=r+g}return n}}const A={showOctaveMarks:!0,showDebugLabels:!1,notesPerColumn:10,columnSpacing:35,columnWidth:100,topMargin:34,noteFontSize:28,noteFontWeight:400,noteVerticalSpacing:44,noteFontFamily:"Noto Sans JP, sans-serif",noteColor:"#000",octaveMarkFontSize:12,octaveMarkFontWeight:500,octaveMarkOffsetX:18,octaveMarkOffsetY:-22,meriKariFontSize:14,meriKariFontWeight:500,durationDotExtraSpacing:12,debugLabelFontSize:7,debugLabelOffsetX:25,debugLabelOffsetY:-6,debugLabelFontFamily:"monospace",debugLabelColor:"#999",width:void 0,height:void 0,autoResize:!0,singleColumn:!1};function $(f={}){return{...A,...f}}class K{constructor(e,t={}){c(this,"container");c(this,"options");c(this,"renderer",null);c(this,"currentNotes",[]);c(this,"currentScoreData",null);c(this,"resizeObserver");this.container=e,this.options=$(t),this.options.autoResize&&this.setupResizeObserver()}async renderFromURL(e){const t=await y.parseFromURL(e);this.currentScoreData=t,await this.renderFromScoreData(t)}async renderFromScoreData(e){this.currentScoreData=e;const t=P.parse(e,this.options.noteColor);this.renderNotes(t)}renderNotes(e){this.currentNotes=e,this.container.innerHTML="";let{width:t,height:i}=this.getViewportDimensions();this.options.singleColumn&&(i=this.calculateSingleColumnHeight(e)),this.renderer=new _(this.container,t,i),V.configureModifiers(e,this.options),j.calculateLayout(e,t,i,this.options).columns.forEach(s=>{const o=e.slice(s.noteStartIndex,s.noteEndIndex);s.notePositions.forEach((n,a)=>{const h=o[a],u=s.xPosition,l=n.y;h.setFontSize(this.options.noteFontSize),h.setFontWeight(this.options.noteFontWeight),h.setPosition(u,l),h.render(this.renderer),this.options.showDebugLabels&&this.renderDebugLabel(h,n.noteIndex,u,l)})})}renderDebugLabel(e,t,i,r){if(!this.renderer)return;const s=e.getSymbolInfo(),n=!s?"rest":(s==null?void 0:s.romaji)||"unknown",a=e.getModifiers().find(d=>d instanceof x),h=a?`(${a.getRegister()})`:"",u=e.getModifiers().find(d=>d instanceof w),l=u?u.getType():"",g=`${t+1} ${n} ${h} ${l}`.trim();this.renderer.drawText(g,i+this.options.debugLabelOffsetX,r+this.options.debugLabelOffsetY,this.options.debugLabelFontSize,this.options.debugLabelFontFamily,this.options.debugLabelColor,"start")}getViewportDimensions(){const e=this.container.getBoundingClientRect();return{width:this.options.width!==void 0?this.options.width:e.width||800,height:this.options.height!==void 0?this.options.height:e.height||600}}calculateSingleColumnHeight(e){let t=this.options.topMargin;for(const i of e){const r=i.getModifiers().some(o=>o instanceof C),s=this.options.noteVerticalSpacing+(r?this.options.durationDotExtraSpacing:0);t+=s}return t+=20,t}refresh(){this.currentNotes.length>0&&this.renderNotes(this.currentNotes)}setOptions(e,t=!0){this.options=$({...this.options,...e}),t&&this.refresh()}resize(e,t){this.setOptions({width:e,height:t},!0)}getOptions(){return{...this.options}}getNotes(){return[...this.currentNotes]}getScoreData(){return this.currentScoreData}clear(){this.container.innerHTML="",this.renderer=null,this.currentNotes=[],this.currentScoreData=null}setupResizeObserver(){typeof ResizeObserver>"u"||(this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.container))}handleResize(){this.currentNotes.length>0&&this.renderNotes(this.currentNotes)}destroy(){this.resizeObserver&&this.resizeObserver.disconnect()}}class T extends HTMLElement{constructor(){super();c(this,"renderer",null);c(this,"shadow");this.shadow=this.attachShadow({mode:"open"})}static get observedAttributes(){return["data-score","columns","auto-resize"]}connectedCallback(){this.render()}attributeChangedCallback(t,i,r){this.isConnected&&i!==r&&this.render()}disconnectedCallback(){this.renderer&&(this.renderer.destroy(),this.renderer=null)}forceRender(){this.render()}parseScoreData(){var r;const t=this.getAttribute("data-score");if(t)try{return JSON.parse(t)}catch(s){throw new Error(`Invalid JSON in data-score attribute: ${s instanceof Error?s.message:"Unknown error"}`)}const i=(r=this.textContent)==null?void 0:r.trim();if(i)try{return JSON.parse(i)}catch(s){throw new Error(`Invalid JSON in textContent: ${s instanceof Error?s.message:"Unknown error"}`)}return null}parseColumnsAttribute(){const t=this.getAttribute("columns");if(!t||t==="auto")return"auto";const i=parseInt(t);return!isNaN(i)&&i>0?i:(console.warn(`shakuhachi-score: invalid columns value "${t}". Use "auto" or a positive number. Defaulting to "auto".`),"auto")}calculateIntrinsicWidth(t){let i=0,r=0;t.forEach(h=>{const u=h.getModifiers();u.find(d=>d.constructor.name==="MeriKariModifier")&&(i=Math.max(i,35)),u.find(d=>d.constructor.name==="OctaveMarksModifier")&&(r=Math.max(r,28))});const o=A.noteFontSize*.8,a=i+o+r+10*2;return Math.ceil(a)}calculateIntrinsicHeight(t){let i=A.topMargin;t.forEach(s=>{const o=s.getModifiers().some(a=>a instanceof C),n=A.noteVerticalSpacing+(o?A.durationDotExtraSpacing:0);i+=n}),i+=20;const r=this.getAttribute("height");return r?parseInt(r):i}getThemeOptions(){const t=getComputedStyle(this);return{noteColor:t.getPropertyValue("--shakuhachi-note-color").trim()||"#000",noteFontSize:parseInt(t.getPropertyValue("--shakuhachi-note-font-size"))||28,noteFontWeight:parseInt(t.getPropertyValue("--shakuhachi-note-font-weight"))||400,noteFontFamily:t.getPropertyValue("--shakuhachi-note-font-family").trim()||"Noto Sans JP, sans-serif",noteVerticalSpacing:parseInt(t.getPropertyValue("--shakuhachi-note-vertical-spacing"))||44}}render(){try{const t=this.parseScoreData();if(!t)return;const i=P.parse(t),r=this.parseColumnsAttribute();let s,o;r==="auto"?(s=!1,o=void 0):r===1?(s=!0,o=void 0):(s=!1,o=Math.ceil(i.length/r));const n=this.getThemeOptions(),a=document.createElement("div");a.className="shakuhachi-score-container";const h=document.createElement("style");h.textContent='@import url("https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap");';const u=document.createElement("style");u.textContent=`
        :host {
          display: block;
          box-sizing: border-box;
          contain-intrinsic-size: 300px 150px;
          --shakuhachi-note-color: #000;
          --shakuhachi-note-font-size: 28px;
          --shakuhachi-note-font-weight: 400;
          --shakuhachi-note-font-family: 'Noto Sans JP', sans-serif;
          --shakuhachi-note-vertical-spacing: 44px;
        }
        .shakuhachi-score-container {
          overflow: visible;
          width: 100%;
          height: 100%;
        }
      `,this.shadow.innerHTML="",this.shadow.appendChild(h),this.shadow.appendChild(u),this.shadow.appendChild(a);let l,g;if(s){g=this.calculateIntrinsicHeight(i);const p=this.getAttribute("width");if(p)l=parseInt(p);else if(this.hasAttribute("intrinsic-width"))l=this.calculateIntrinsicWidth(i);else{const m=this.getBoundingClientRect();l=m.width>0?m.width:300}}else{const p=this.getAttribute("width"),m=this.getAttribute("height");l=p?parseInt(p):this.clientWidth||300,g=m?parseInt(m):this.clientHeight||150}const d={singleColumn:s,notesPerColumn:o,showDebugLabels:this.hasAttribute("debug"),autoResize:this.getAttribute("auto-resize")!=="false",width:l,height:g,...n};this.renderer=new K(a,d),this.renderer.renderFromScoreData(t)}catch(t){this.renderError(t)}}renderError(t){const i=document.createElement("div");i.textContent=`Error: ${t.message}`,i.style.cssText="color: #ef4444; font-family: system-ui; font-size: 14px;",this.shadow.innerHTML="",this.shadow.appendChild(i),console.error("shakuhachi-score rendering error:",t),console.error("Stack trace:",t.stack)}}return customElements.define("shakuhachi-score",T),b.ShakuhachiScore=T,Object.defineProperty(b,Symbol.toStringTag,{value:"Module"}),b}({});
