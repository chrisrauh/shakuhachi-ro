<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modifier Combinations Test</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸªˆ</text></svg>"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Noto Sans JP', 'Noto Sans', sans-serif;
        background: white;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      header {
        flex-shrink: 0;
        padding: 20px 40px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
      }

      h1 {
        font-size: 1.5rem;
        margin-bottom: 10px;
        font-weight: 300;
      }

      .subtitle {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.6;
      }

      .test-info {
        margin-top: 10px;
        padding: 10px;
        background: #e8f5e9;
        border: 1px solid #4caf50;
        border-radius: 4px;
        font-size: 0.85rem;
      }

      .test-info strong {
        color: #2e7d32;
      }

      #display {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        overflow: auto;
        padding: 20px;
      }

      #display.debug svg {
        border: 2px solid #e74c3c;
      }

      .error {
        color: #e74c3c;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ðŸŽµ Modifier Combinations Test</h1>
      <p class="subtitle">
        Testing all combinations of modifiers: octave marks (ä¹™/ç”²), meri degrees (ãƒ¡/ä¸­/å¤§), and duration dots
      </p>
      <div class="test-info">
        <strong>Test coverage:</strong><br>
        â€¢ Meri + Octave marks<br>
        â€¢ Meri + Duration dots<br>
        â€¢ All modifiers together (meri + octave + dot)<br>
        â€¢ Edge cases (first note, rests, context changes)
      </div>
    </header>

    <div id="display"></div>

    <script type="module">
      import { ScoreParser } from './src/parser/ScoreParser';
      import { SVGRenderer } from './src/renderer/SVGRenderer';

      const display = document.getElementById('display');

      // Check for debug query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const showDebug = urlParams.get('debug') === 'true';

      if (showDebug) {
        display.classList.add('debug');
      }

      async function renderTestScore() {
        try {
          console.log('Loading modifier combinations test...');

          // Load test score
          const response = await fetch(`${import.meta.env.BASE_URL}data/test-modifier-combinations.json`);
          if (!response.ok) {
            throw new Error(`Failed to load: ${response.statusText}`);
          }
          const scoreData = await response.json();
          console.log('Loaded test score:', scoreData);

          // Convert to ShakuNote objects using ScoreParser
          const allNotes = ScoreParser.parse(scoreData);
          console.log(`Converted to ${allNotes.length} ShakuNote objects`);

          // Debug: log each note's modifiers
          allNotes.forEach((note, i) => {
            const mods = note.getModifiers();
            const modNames = mods.map(m => m.constructor.name).join(', ');
            console.log(
              `Note ${i + 1}:`,
              note.getKana(),
              `[${modNames || 'no modifiers'}]`
            );
          });

          // Create SVG renderer
          const displayRect = display.getBoundingClientRect();
          const svgWidth = displayRect.width;
          const svgHeight = displayRect.height;
          const renderer = new SVGRenderer(display, svgWidth, svgHeight);
          console.log(`SVG size: ${svgWidth}x${svgHeight}`);

          // Single column layout for easy reading
          const columnWidth = 100;
          const startY = 70;
          const verticalSpacing = 55;
          const fontSize = 28;
          const startX = svgWidth / 2;

          // Render notes in a single vertical column
          let currentY = startY;
          allNotes.forEach((note, index) => {
            note.setFontSize(fontSize);
            note.setPosition(startX, currentY);
            note.render(renderer);

            // Debug labels
            if (showDebug) {
              const symbolInfo = note.getSymbolInfo();
              const romaji = symbolInfo?.romaji || 'rest';
              const mods = note.getModifiers();
              const modLabels = [];

              mods.forEach(m => {
                if (m.constructor.name === 'OctaveMarksModifier') {
                  modLabels.push('ç”²');
                } else if (m.constructor.name === 'MeriKariModifier') {
                  const type = m.getType();
                  if (type === 'meri') modLabels.push('ãƒ¡');
                  else if (type === 'chu-meri') modLabels.push('ä¸­');
                  else if (type === 'dai-meri') modLabels.push('å¤§');
                } else if (m.constructor.name === 'DurationDotModifier') {
                  modLabels.push('â€¢');
                }
              });

              const label = `#${index + 1} ${romaji} ${modLabels.length ? `[${modLabels.join(' ')}]` : ''}`.trim();

              renderer.drawText(
                label,
                startX + 50,
                currentY + 5,
                12,
                'monospace',
                modLabels.length ? '#1976d2' : '#999'
              );
            }

            currentY += verticalSpacing;
          });

          console.log('Modifier combinations test rendered!');
        } catch (error) {
          console.error('Error:', error);
          display.innerHTML = `<div class="error">Error: ${error.message}<br><br>Stack: ${error.stack}</div>`;
        }
      }

      // Render when page loads
      renderTestScore();
    </script>
  </body>
</html>
