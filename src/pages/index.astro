---
import Layout from '../layouts/Layout.astro';
import PageHeader from '../components/PageHeader.astro';

// Prerender this page at build time (static HTML)
export const prerender = true;
---

<Layout title="Shakuhachi Score Library" currentPage="browse">
  <PageHeader slot="header-metadata" title="Shakuhachi.ro" />

  <div id="delete-banner" style="display: none;" class="delete-banner">
    <span id="delete-banner-message"></span>
    <button id="delete-banner-close" class="delete-banner-close" aria-label="Dismiss">âœ•</button>
  </div>

  <div id="score-library"></div>

  <script is:inline>
    // Show deletion confirmation banner if redirected after deleting a score
    const deleted = sessionStorage.getItem('score-deleted');
    if (deleted) {
      sessionStorage.removeItem('score-deleted');
      const banner = document.getElementById('delete-banner');
      const msg = document.getElementById('delete-banner-message');
      if (banner && msg) {
        msg.textContent = '\u201c' + deleted + '\u201d was deleted.';
        banner.style.display = 'flex';
      }
      document.getElementById('delete-banner-close')?.addEventListener('click', () => {
        if (banner) banner.style.display = 'none';
      });
    }
  </script>

  <script>
    import { createElement, Book, Plus, Info, SunMoon } from 'lucide';
    import { ThemeSwitcher } from '../components/ThemeSwitcher';
    import { AuthWidget } from '../components/AuthComponents';
    import { onAuthReady } from '../api/auth';
    import { ScoreLibrary } from '../components/ScoreLibrary';
    import { MobileMenu } from '../components/MobileMenu';
    import { createEmptyScore } from '../utils/create-score-handler';

    // Initialize theme switcher
    new ThemeSwitcher('theme-switcher');

    // Initialize auth widget
    const authWidget = new AuthWidget('auth-widget');

    // Subscribe to auth changes - onAuthReady handles deduplication
    onAuthReady((user) => {
      authWidget.setUser(user);
    });

    // Initialize score library
    new ScoreLibrary('score-library');

    // Helper to generate Lucide icon HTML
    const getIconHTML = (iconComponent: typeof Book) => {
      const icon = createElement(iconComponent);
      icon.setAttribute('width', '16');
      icon.setAttribute('height', '16');
      icon.setAttribute('stroke-width', '2');
      return icon.outerHTML;
    };

    // Initialize mobile menu
    const toggleTheme = () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
    };

    const mobileMenu = new MobileMenu('mobile-menu');
    mobileMenu.setItems([
      {
        id: 'browse',
        label: 'Library',
        href: '/',
        icon: getIconHTML(Book),
        dividerAfter: false,
      },
      {
        id: 'create',
        label: 'Create score',
        action: async () => {
          const result = await createEmptyScore();
          if (result.error) {
            alert(result.error.message);
          } else {
            window.location.href = `/score/${result.slug}/edit`;
          }
        },
        icon: getIconHTML(Plus),
        dividerAfter: false,
      },
      {
        id: 'about',
        label: 'About',
        href: '/about',
        icon: getIconHTML(Info),
        dividerAfter: true,
      },
      {
        id: 'theme',
        label: 'Toggle theme',
        action: toggleTheme,
        icon: getIconHTML(SunMoon),
        dividerAfter: false,
      },
    ]);
  </script>
  <style>
    .delete-banner {
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-small);
      padding: var(--spacing-small) var(--spacing-medium);
      background: var(--color-success-background);
      color: var(--color-success);
      border-bottom: 1px solid var(--color-success);
      font-size: var(--font-size-small);
    }

    .delete-banner-close {
      background: none;
      border: none;
      cursor: pointer;
      color: inherit;
      padding: 0;
      font-size: var(--font-size-base);
      line-height: 1;
      flex-shrink: 0;
    }
  </style>
</Layout>
