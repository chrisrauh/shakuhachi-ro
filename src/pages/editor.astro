---
import Layout from '../layouts/Layout.astro';

// Prerender this page at build time (static HTML)
export const prerender = true;
---

<Layout title="Score Editor - Shakuhachi Score Library" currentPage="create" noPadding={true}>
  <div id="score-editor"></div>

  <script>
    import { createElement, Book, Plus, SunMoon } from 'lucide';
    import { ThemeSwitcher } from '../components/ThemeSwitcher';
    import { AuthWidget } from '../components/AuthComponents';
    import { authState } from '../api/authState';
    import { ScoreEditor } from '../components/ScoreEditor';
    import { MobileMenu } from '../components/MobileMenu';

    // Initialize theme switcher
    new ThemeSwitcher('theme-switcher');

    // Initialize auth widget
    const authWidget = new AuthWidget('auth-widget');

    // Subscribe to auth state changes
    authState.subscribe((user) => {
      if (user) {
        authWidget.setUser(user);
      } else {
        authWidget.setUser(null);
      }
    });

    // Get score ID from URL if editing
    const urlParams = new URLSearchParams(window.location.search);
    const scoreId = urlParams.get('id');

    // Initialize score editor
    new ScoreEditor('score-editor', scoreId || undefined);

    // Helper to generate Lucide icon HTML
    const getIconHTML = (iconComponent: typeof Book) => {
      const icon = createElement(iconComponent);
      icon.setAttribute('width', '16');
      icon.setAttribute('height', '16');
      icon.setAttribute('stroke-width', '2');
      return icon.outerHTML;
    };

    // Initialize mobile menu
    const toggleTheme = () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
    };

    const mobileMenu = new MobileMenu('mobile-menu');
    mobileMenu.setItems([
      {
        id: 'browse',
        label: 'View Scores',
        href: '/',
        icon: getIconHTML(Book),
        dividerAfter: false,
      },
      {
        id: 'create',
        label: 'Create Score',
        href: '/editor',
        icon: getIconHTML(Plus),
        dividerAfter: true,
      },
      {
        id: 'theme',
        label: 'Toggle Theme',
        action: toggleTheme,
        icon: getIconHTML(SunMoon),
        dividerAfter: false,
      },
    ]);
  </script>
</Layout>
