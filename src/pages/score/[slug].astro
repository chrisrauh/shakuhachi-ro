---
import Layout from '../../layouts/Layout.astro';
import { getScoreBySlug, getScore } from '../../api/scores';
import { GitFork, Calendar, SquarePen } from '@lucide/astro';

// In server mode, this page SSRs all routes dynamically
// (getStaticPaths not used - all score URLs render on-demand)
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Server-side fetch
const scoreResult = await getScoreBySlug(slug);
const { score } = scoreResult;

if (!score) {
  return Astro.redirect('/');
}

// Fetch parent score if forked
let parentScore = null;
if (score.forked_from) {
  const parentResult = await getScore(score.forked_from);
  parentScore = parentResult.score;
}

const formattedDate = new Date(score.created_at).toLocaleDateString('en-US', {
  month: 'short',
  day: 'numeric',
  year: 'numeric'
});
---

<Layout title={`${score.title} - Shakuhachi Score Library`} currentPage="score">
  <!-- Score metadata in header -->
  <div slot="header-metadata" class="score-header-metadata">
    <h1 class="score-title">{score.title}</h1>
    {score.composer && (
      <>
        <span class="metadata-separator">路</span>
        <span>By {score.composer}</span>
      </>
    )}
    <span class="metadata-separator">路</span>
    <span class="score-stat">
      <GitFork size={14} />
      {score.fork_count}
      <button id="fork-btn"
              class="inline-action-btn"
              aria-label="Fork score">
        <GitFork size={12} />
      </button>
    </span>
    <span class="metadata-separator">路</span>
    <span class="score-stat">
      <Calendar size={14} />
      {formattedDate}
    </span>
    {parentScore && (
      <>
        <span class="metadata-separator">路</span>
        <span>
          Forked from <a href={`/score/${parentScore.slug}`}>{parentScore.title}</a>
        </span>
      </>
    )}
  </div>

  <!-- Score content -->
  <div class="score-detail-container">
    <!-- Owner-only edit button (floating) -->
    <a href={`/editor.html?id=${score.id}`}
       class="floating-edit-btn"
       id="edit-btn"
       aria-label="Edit score"
       style="display: none;">
      <SquarePen size={16} />
    </a>

    <!-- Score renderer container -->
    <div id="score-renderer-container"></div>
  </div>

  <!-- Embed score data for client -->
  <script id="score-data" type="application/json" is:inline set:html={JSON.stringify({ score, parentScore })}></script>

  <!-- Initialize theme switcher and auth widget -->
  <script>
    import { ThemeSwitcher } from '../../components/ThemeSwitcher';
    import { AuthWidget } from '../../components/AuthComponents';
    import { authState } from '../../api/authState';

    // Initialize theme switcher
    new ThemeSwitcher('theme-switcher');

    // Initialize auth widget
    const authWidget = new AuthWidget('auth-widget');

    // Subscribe to auth state changes
    authState.subscribe((user) => {
      if (user) {
        authWidget.setUser(user);
      } else {
        authWidget.setUser(null);
      }
    });
  </script>

  <!-- Client-side logic -->
  <script>
    import { ScoreDetailClient } from '../../components/ScoreDetailClient';
    const client = new ScoreDetailClient();
    client.init();
  </script>

  <style>
    /* Header metadata styling (in header slot) */
    :global(.score-header-metadata) {
      display: flex;
      align-items: center;
      gap: var(--spacing-x-small);
      font-size: var(--font-size-small);
      color: var(--color-neutral-600);
      flex-wrap: wrap;
    }

    :global(.score-title) {
      font-size: var(--font-size-large);
      font-weight: var(--font-weight-semibold);
      color: var(--color-neutral-900);
      margin: 0;
    }

    :global(.metadata-separator) {
      color: var(--color-neutral-400);
    }

    :global(.score-stat) {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-3x-small);
    }

    :global(.inline-action-btn) {
      padding: var(--spacing-3x-small) var(--spacing-2x-small);
      margin-left: var(--spacing-3x-small);
      cursor: pointer;
      background: transparent;
      border: var(--input-border-width) solid var(--color-neutral-300);
      border-radius: var(--border-radius-small);
      color: var(--color-neutral-600);
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 0;
      vertical-align: middle;
    }

    :global(.inline-action-btn:hover) {
      background: var(--color-neutral-100);
      border-color: var(--color-neutral-400);
      color: var(--color-neutral-700);
    }

    :global(.inline-action-btn:active) {
      transform: translateY(1px);
    }

    :global(.inline-action-btn:disabled) {
      opacity: 0.5;
      cursor: not-allowed;
    }

    :global(.score-header-metadata a) {
      color: var(--color-primary-600);
      text-decoration: none;
    }

    :global(.score-header-metadata a:hover) {
      text-decoration: underline;
    }

    /* Page content styling */
    .score-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-large);
      position: relative;
    }

    .floating-edit-btn {
      position: fixed;
      top: 80px;
      right: var(--spacing-large);
      padding: var(--spacing-x-small);
      cursor: pointer;
      background: var(--page-background-color);
      border: var(--input-border-width) solid var(--color-neutral-300);
      border-radius: var(--border-radius-medium);
      color: var(--color-neutral-700);
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 0;
      text-decoration: none;
      z-index: 50;
      box-shadow: var(--shadow-small);
    }

    .floating-edit-btn:hover {
      background: var(--color-neutral-100);
      border-color: var(--color-neutral-400);
      box-shadow: var(--shadow-medium);
    }

    #score-renderer-container {
      margin-top: var(--spacing-large);
    }

    /* Responsive */
    @media (max-width: 768px) {
      :global(.score-header-metadata) {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-2x-small);
      }

      :global(.score-title) {
        font-size: var(--font-size-medium);
      }

      .floating-edit-btn {
        top: 120px;
        right: var(--spacing-medium);
      }
    }
  </style>
</Layout>
