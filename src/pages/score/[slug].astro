---
import Layout from '../../layouts/Layout.astro';
import PageHeader from '../../components/PageHeader.astro';
import { getScoreBySlug, getScore } from '../../api/scores';
import { GitFork, SquarePen } from '@lucide/astro';

// In server mode, this page SSRs all routes dynamically
// (getStaticPaths not used - all score URLs render on-demand)
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Server-side fetch
const scoreResult = await getScoreBySlug(slug);
const { score } = scoreResult;

if (!score) {
  return Astro.redirect('/');
}

// Fetch parent score if forked
let parentScore = null;
if (score.forked_from) {
  const parentResult = await getScore(score.forked_from);
  parentScore = parentResult.score;
}
---

<Layout title={`${score.title} - Shakuhachi Score Library`} currentPage="score" fullHeight={true}>
  <!-- Score metadata in header -->
  <PageHeader slot="header-metadata" title={score.title}>
    {parentScore && (
      <span>
        forked from <a href={`/score/${parentScore.slug}`}>{parentScore.title}</a>
      </span>
    )}

    <span class="score-stat">
      updated <relative-time datetime={score.created_at} format="relative"></relative-time>
    </span>
  </PageHeader>

  <!-- Header actions (right side of navbar) -->
  <div slot="header-actions" style="display: flex; gap: var(--spacing-small); align-items: center;">
    <!-- Owner-only edit button -->
    <a href={`/score/${score.slug}/edit`}
       class="btn btn-icon"
       id="edit-btn"
       aria-label="Edit score"
       style="display: none;">
      <SquarePen size={16} />
    </a>

    <!-- Fork button -->
    <button id="fork-btn"
            class="btn btn-icon-with-count"
            aria-label="Fork this score">
      <GitFork size={16} />
      <span class="count">{score.fork_count}</span>
    </button>
  </div>

  <!-- Score content -->
  <div class="score-detail-container">

    <!-- Score renderer container -->
    <div id="score-renderer-container"></div>
  </div>

  <!-- Embed score data for client -->
  <script id="score-data" type="application/json" is:inline set:html={JSON.stringify({ score, parentScore })}></script>

  <!-- Initialize relative-time web component -->
  <script>
    import '@github/relative-time-element';
  </script>

  <!-- Initialize theme switcher and auth widget -->
  <script>
    import { createElement, Book, Plus, Info, SunMoon } from 'lucide';
    import { ThemeSwitcher } from '../../components/ThemeSwitcher';
    import { AuthWidget } from '../../components/AuthComponents';
    import { authState } from '../../api/authState';
    import { MobileMenu } from '../../components/MobileMenu';

    // Initialize theme switcher
    new ThemeSwitcher('theme-switcher');

    // Initialize auth widget
    const authWidget = new AuthWidget('auth-widget');

    // Subscribe to auth state changes
    authState.subscribe((user) => {
      if (user) {
        authWidget.setUser(user);
      } else {
        authWidget.setUser(null);
      }
    });

    // Helper to generate Lucide icon HTML
    const getIconHTML = (iconComponent: typeof Book) => {
      const icon = createElement(iconComponent);
      icon.setAttribute('width', '16');
      icon.setAttribute('height', '16');
      icon.setAttribute('stroke-width', '2');
      return icon.outerHTML;
    };

    // Initialize mobile menu
    const toggleTheme = () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
    };

    const mobileMenu = new MobileMenu('mobile-menu');
    mobileMenu.setItems([
      {
        id: 'browse',
        label: 'Library',
        href: '/',
        icon: getIconHTML(Book),
        dividerAfter: false,
      },
      {
        id: 'create',
        label: 'Create score',
        href: '/editor',
        icon: getIconHTML(Plus),
        dividerAfter: false,
      },
      {
        id: 'about',
        label: 'About',
        href: '/about',
        icon: getIconHTML(Info),
        dividerAfter: true,
      },
      {
        id: 'theme',
        label: 'Toggle theme',
        action: toggleTheme,
        icon: getIconHTML(SunMoon),
        dividerAfter: false,
      },
    ]);
  </script>

  <!-- Client-side logic -->
  <script>
    import { ScoreDetailClient } from '../../components/ScoreDetailClient';
    const client = new ScoreDetailClient();
    client.init();
  </script>

  <style>
    :global(.metadata-separator) {
      color: var(--color-separator);
    }

    :global(.score-stat) {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-3x-small);
    }

    /* GitHub-style fork button with integrated counter */
    :global(.btn-icon-with-count) {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-x-small);
      padding: var(--spacing-button) var(--spacing-small);
      border: 1px solid var(--color-border);
      background: var(--color-bg-subtle);
      color: var(--color-text-primary);
      border-radius: var(--border-radius-medium);
      font-size: var(--font-size-small);
      font-weight: var(--font-weight-semibold);
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    :global(.btn-icon-with-count:hover) {
      background: var(--color-bg-hover);
      border-color: var(--color-border-hover);
    }

    :global(.btn-icon-with-count:active) {
      transform: translateY(1px);
    }

    :global(.btn-icon-with-count:disabled) {
      opacity: 0.5;
      cursor: not-allowed;
    }

    :global(.btn-icon-with-count .count) {
      line-height: var(--line-height-denser);
    }

    :global(.score-header-metadata a) {
      color: var(--color-link);
      text-decoration: none;
    }

    :global(.score-header-metadata a:hover) {
      text-decoration: underline;
    }

    /* Page content styling */
    .score-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-large) var(--spacing-large) 0;
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #score-renderer-container {
      flex: 1;
      min-height: 0; /* Important for flex child with overflow */
    }

    :global(#score-renderer-container svg) {
      display: block; /* Remove inline descender space */
    }

    /* Responsive */
    @media (max-width: 768px) {
      :global(.score-header-metadata) {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-2x-small);
      }

      :global(.score-title) {
        font-size: var(--font-size-medium);
      }

      .floating-edit-btn {
        top: 120px;
        right: var(--spacing-medium);
      }

      /* Mobile score rendering - allow natural height expansion */
      .score-detail-container {
        flex: none; /* Remove flex constraint */
        overflow: visible; /* Allow content to overflow viewport */
        padding: var(--spacing-medium) var(--spacing-small) 0;
        max-width: 100%; /* Constrain to viewport width */
      }

      #score-renderer-container {
        flex: none; /* Remove flex constraint */
        min-height: auto; /* Allow natural height */
        width: 100%; /* Full width of container */
      }

      /* Remove fullHeight layout on mobile */
      :global(body.full-height) {
        height: auto;
        min-height: 100vh;
      }

      :global(body.full-height main) {
        flex: none;
        overflow: visible;
      }
    }
  </style>
</Layout>
