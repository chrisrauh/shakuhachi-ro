---
import Layout from '../../layouts/Layout.astro';
import PageHeader from '../../components/PageHeader.astro';
import Error404 from '../../components/Error404.astro';
import { getScoreBySlug, getScore } from '../../api/scores';
import { GitFork, SquarePen } from '@lucide/astro';

// In server mode, this page SSRs all routes dynamically
// (getStaticPaths not used - all score URLs render on-demand)
const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Server-side fetch
const scoreResult = await getScoreBySlug(slug);
const { score } = scoreResult;

if (!score) {
  Astro.response.status = 404;
}

// Fetch parent score if forked
let parentScore = null;
if (score?.forked_from) {
  const parentResult = await getScore(score.forked_from);
  parentScore = parentResult.score;
}
---

{score ? (
<Layout title={`${score.title} - Shakuhachi Score Library`} currentPage="score" fullHeight={true}>
  <!-- Score metadata in header -->
  <PageHeader slot="header-metadata" title={score.title}>
    {parentScore ? (
      <span>
        forked from <a href={`/score/${parentScore.slug}`}>{parentScore.title}</a>
      </span>
    ) : (
      <span class="score-stat">
        updated <relative-time datetime={score.created_at} format="relative"></relative-time>
      </span>
    )}
  </PageHeader>

  <!-- Header actions (right side of navbar) -->
  <div slot="header-actions" style="display: flex; gap: var(--spacing-small); align-items: center;">
    <!-- Owner-only edit button -->
    <a href={`/score/${score.slug}/edit`}
       class="btn btn-icon"
       id="edit-btn"
       aria-label="Edit score"
       style="display: none;">
      <SquarePen size={16} />
    </a>

    <!-- Fork button -->
    <button id="fork-btn"
            class="btn btn-icon-with-count"
            aria-label="Fork this score"
            title="Create your own editable copy of this score">
      <GitFork size={16} />
      <span class="count">{score.fork_count}</span>
    </button>
  </div>

  <!-- Score content -->
  <div class="score-detail-container">

    <!-- Score renderer container -->
    <div id="score-renderer-container"></div>
  </div>

  <!-- Embed score data for client -->
  <script id="score-data" type="application/json" is:inline set:html={JSON.stringify({ score, parentScore })}></script>

  <!-- Initialize relative-time web component -->
  <script>
    import '@github/relative-time-element';
  </script>

  <!-- Initialize theme switcher and auth widget -->
  <script>
    import { createElement, Book, Plus, Info, SunMoon, SquarePen } from 'lucide';
    import { ThemeSwitcher } from '../../components/ThemeSwitcher';
    import { AuthWidget } from '../../components/AuthComponents';
    import { onAuthStateChange } from '../../api/auth';
    import { MobileMenu, type MenuItem } from '../../components/MobileMenu';

    // Initialize theme switcher
    new ThemeSwitcher('theme-switcher');

    // Initialize auth widget
    const authWidget = new AuthWidget('auth-widget');

    // Subscribe to auth changes - INITIAL_SESSION provides initial state
    onAuthStateChange((user, _session, event) => {
      if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
        authWidget.setUser(user);
      }
    });

    // Helper to generate Lucide icon HTML
    const getIconHTML = (iconComponent: typeof Book) => {
      const icon = createElement(iconComponent);
      icon.setAttribute('width', '16');
      icon.setAttribute('height', '16');
      icon.setAttribute('stroke-width', '2');
      return icon.outerHTML;
    };

    // Initialize mobile menu
    const toggleTheme = () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
    };

    const mobileMenu = new MobileMenu('mobile-menu');

    // Function to update mobile menu items based on auth state
    const updateMobileMenuItems = (isOwner: boolean) => {
      const baseItems: MenuItem[] = [
        {
          id: 'browse',
          label: 'Library',
          href: '/',
          icon: getIconHTML(Book),
          dividerAfter: false,
        },
        {
          id: 'create',
          label: 'Create score',
          href: '/editor',
          icon: getIconHTML(Plus),
          dividerAfter: false,
        },
        {
          id: 'about',
          label: 'About',
          href: '/about',
          icon: getIconHTML(Info),
          dividerAfter: !isOwner, // Add divider if no edit button follows
        },
      ];

      // Add edit button if user owns the score
      if (isOwner) {
        const editBtn = document.getElementById('edit-btn') as HTMLAnchorElement;
        if (editBtn) {
          baseItems.push({
            id: 'edit',
            label: 'Edit score',
            href: editBtn.href,
            icon: getIconHTML(SquarePen),
            dividerAfter: true,
          });
        }
      }

      baseItems.push({
        id: 'theme',
        label: 'Toggle theme',
        action: toggleTheme,
        icon: getIconHTML(SunMoon),
        dividerAfter: false,
      });

      mobileMenu.setItems(baseItems);
    };

    // Get score data to check ownership
    const dataEl = document.getElementById('score-data');
    if (dataEl) {
      try {
        const data = JSON.parse(dataEl.textContent || '{}');
        const score = data.score;

        // Subscribe to auth changes - INITIAL_SESSION provides initial state
        onAuthStateChange((user, _session, event) => {
          if (event === 'INITIAL_SESSION' || event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
            const isOwner = !!(user && score && user.id === score.user_id);
            updateMobileMenuItems(isOwner);
          }
        });
      } catch (error) {
        console.error('Failed to parse score data for menu:', error);
        updateMobileMenuItems(false);
      }
    } else {
      updateMobileMenuItems(false);
    }
  </script>

  <!-- Client-side logic -->
  <script>
    import { ScoreDetailClient } from '../../components/ScoreDetailClient';
    const client = new ScoreDetailClient();
    client.init();
  </script>

  <style>
    :global(.metadata-separator) {
      color: var(--color-separator);
    }

    :global(.score-stat) {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-3x-small);
    }

    :global(.score-header-metadata a) {
      color: var(--color-link);
      text-decoration: none;
    }

    :global(.score-header-metadata a:hover) {
      text-decoration: underline;
    }

    /* Page content styling */
    .score-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-large) var(--spacing-large) 0;
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #score-renderer-container {
      flex: 1;
      min-height: 0; /* Important for flex child with overflow */
    }

    :global(#score-renderer-container svg) {
      display: block; /* Remove inline descender space */
    }

    /* Responsive */
    @media (max-width: 768px) {
      :global(.score-header-metadata) {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--spacing-2x-small);
      }

      :global(.score-title) {
        font-size: var(--font-size-medium);
      }

      /* Hide desktop edit button on mobile - shown in menu instead */
      :global(#edit-btn) {
        display: none !important;
      }

      .floating-edit-btn {
        top: 120px;
        right: var(--spacing-medium);
      }

      /* Mobile score rendering - allow natural height expansion */
      .score-detail-container {
        flex: none; /* Remove flex constraint */
        overflow: visible; /* Allow content to overflow viewport */
        padding: var(--spacing-medium) var(--spacing-small) 0;
        max-width: 100%; /* Constrain to viewport width */
      }

      #score-renderer-container {
        flex: none; /* Remove flex constraint */
        min-height: auto; /* Allow natural height */
        width: 100%; /* Full width of container */
      }

      /* Remove fullHeight layout on mobile */
      :global(body.full-height) {
        height: auto;
        min-height: 100vh;
      }

      :global(body.full-height main) {
        flex: none;
        overflow: visible;
      }
    }
  </style>
</Layout>
) : (
<Layout title="Page Not Found - Shakuhachi.ro" currentPage="score">
  <PageHeader slot="header-metadata" title="Page Not Found" />
  <Error404 />
</Layout>
)}
