---
import Layout from '../layouts/Layout.astro';
import PageHeader from '../components/PageHeader.astro';
import { getEntry } from 'astro:content';

// Prerender this page at build time (static HTML)
export const prerender = true;

// Load MDX content
const aboutPage = await getEntry('pages', 'about');
const { Content } = await aboutPage.render();
---

<Layout title="About - Shakuhachi.ro" currentPage="browse">
  <PageHeader slot="header-metadata" title="About" />

  <div class="about-page">
    <div class="about-section">
      <Content />
    </div>
  </div>

  <!-- Load web component for score examples -->
  <script is:inline src="/embed/shakuhachi-score.js"></script>

  <script>
    import { createElement, Book, Plus, Info, SunMoon } from 'lucide';
    import { ThemeSwitcher } from '../components/ThemeSwitcher';
    import { AuthWidget } from '../components/AuthComponents';
    import { onAuthReady } from '../api/auth';
    import { MobileMenu } from '../components/MobileMenu';
    import { createEmptyScore } from '../utils/create-score-handler';

    // Initialize theme switcher
    new ThemeSwitcher('theme-switcher');

    // Initialize letter spacing control (dev only)
    if (import.meta.env.DEV) {
      import('../components/LetterSpacingControl').then(({ LetterSpacingControl }) => {
        new LetterSpacingControl('letter-spacing-control');
      });
    }

    // Initialize auth widget
    const authWidget = new AuthWidget('auth-widget');

    // Subscribe to auth changes - onAuthReady handles deduplication
    onAuthReady((user) => {
      authWidget.setUser(user);
    });

    // Helper to generate Lucide icon HTML
    const getIconHTML = (iconComponent: typeof Book) => {
      const icon = createElement(iconComponent);
      icon.setAttribute('width', '16');
      icon.setAttribute('height', '16');
      icon.setAttribute('stroke-width', '2');
      return icon.outerHTML;
    };

    // Initialize mobile menu
    const toggleTheme = () => {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      html.setAttribute('data-theme', newTheme);
    };

    const mobileMenu = new MobileMenu('mobile-menu');
    mobileMenu.setItems([
      {
        id: 'browse',
        label: 'Library',
        href: '/',
        icon: getIconHTML(Book),
        dividerAfter: false,
      },
      {
        id: 'create',
        label: 'Create score',
        action: async () => {
          const result = await createEmptyScore();
          if (result.error) {
            alert(result.error.message);
          } else {
            window.location.href = `/score/${result.slug}/edit`;
          }
        },
        icon: getIconHTML(Plus),
        dividerAfter: false,
      },
      {
        id: 'about',
        label: 'About',
        href: '/about',
        icon: getIconHTML(Info),
        dividerAfter: true,
      },
      {
        id: 'theme',
        label: 'Toggle theme',
        action: toggleTheme,
        icon: getIconHTML(SunMoon),
        dividerAfter: false,
      },
    ]);
  </script>

  <style>
    .about-page {
      max-width: 720px;
      margin: 0 auto;
      padding: 0 var(--spacing-medium);
    }

    .about-section {
      margin-bottom: var(--spacing-2x-large);
    }

    .about-section :global(h2) {
      font-size: var(--font-size-x-large);
      font-weight: 500;
      margin-bottom: var(--spacing-medium);
      color: var(--color-text-heading);
    }

    .about-section :global(h3) {
      font-size: var(--font-size-large);
      font-weight: 500;
      margin-bottom: var(--spacing-small);
      color: var(--color-text-heading);
    }

    .about-section :global(p) {
      font-size: var(--font-size-medium);
      line-height: 1.6;
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-medium);
    }

    .about-section :global(p:last-child) {
      margin-bottom: 0;
    }

    .about-section :global(a) {
      color: var(--color-link);
      text-decoration: none;
      border-bottom: 1px solid var(--color-link-border);
      transition: border-color var(--transition-fast);
    }

    .about-section :global(a:hover) {
      border-bottom-color: var(--color-link-border-hover);
    }

    .about-section :global(strong) {
      font-weight: 600;
      color: var(--color-text-heading);
    }

    .about-section :global(pre) {
      border-radius: var(--border-radius-medium);
      padding: var(--spacing-medium);
      margin: var(--spacing-medium) 0;
      overflow-x: auto;
      font-size: var(--font-size-small);
      line-height: 1.5;
    }

    /* Switch to dark theme colors when in dark mode */
    :global([data-theme='dark']) .about-section :global(pre) {
      background-color: var(--shiki-dark-bg) !important;
      color: var(--shiki-dark) !important;
    }

    :global([data-theme='dark']) .about-section :global(pre span) {
      color: var(--shiki-dark) !important;
    }

    .about-section :global(code) {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'source-code-pro', monospace;
    }

    .about-section :global(p code) {
      background-color: var(--color-background-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-small);
      padding: 2px 6px;
      font-size: 0.9em;
    }

    /* Score Example Styling */
    .about-section :global(.score-example) {
      margin: var(--spacing-large) 0;
      padding: var(--spacing-large);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-medium);
      background-color: var(--color-background-elevated);
      display: flex;
      gap: var(--spacing-large);
      align-items: flex-start;
    }

    .about-section :global(.score-viz) {
      flex: 0 0 auto;
      min-width: 120px;
      --shakuhachi-note-color: var(--color-text-primary);
    }

    .about-section :global(.score-comments) {
      flex: 1 1 auto;
      min-width: 0;
      font-size: var(--font-size-small);
      line-height: 1.6;
      color: var(--color-text-secondary);
    }

    .about-section :global(.score-comments strong) {
      font-weight: 600;
      color: var(--color-text-heading);
    }

    .about-section :global(.score-comments ul) {
      margin: var(--spacing-small) 0;
      padding-left: var(--spacing-medium);
    }

    .about-section :global(.score-comments li) {
      margin-bottom: var(--spacing-x-small);
    }

    @media (max-width: 768px) {
      .about-page {
        padding: 0 var(--spacing-small);
      }

      .about-section :global(h2) {
        font-size: var(--font-size-large);
      }

      .about-section :global(h3) {
        font-size: var(--font-size-medium);
      }

      .about-section :global(p) {
        font-size: var(--font-size-small);
      }

      .about-section :global(.score-example) {
        flex-direction: column;
        padding: var(--spacing-medium);
      }

      .about-section :global(.score-viz) {
        width: 100%;
      }
    }
  </style>
</Layout>
